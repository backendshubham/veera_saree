<%- include('../partials/header') %>
<%- include('../partials/navbar', { userId: typeof userId !== 'undefined' ? userId : null, userName: typeof userName !== 'undefined' ? userName : null, currentPage: 'home' }) %>

<% if (typeof flash !== 'undefined' && flash) { %>
    <div class="container mt-3">
        <div class="alert alert-<%= flash.type === 'error' ? 'danger' : 'success' %> alert-dismissible fade show" role="alert">
            <%= flash.message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
<% } %>

<!-- Hero Carousel -->
<div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="5000">
    <div class="carousel-indicators">
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
    </div>
    
    <div class="carousel-inner">
        <!-- Slide 1 -->
        <div class="carousel-item active">
            <div class="hero-slide hero-slide-1" style="position: relative; overflow: hidden;">
                <!-- Background Video -->
                <video autoplay muted loop playsinline style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;">
                    <source src="/assets/background.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <!-- Content -->
                <div class="container" style="position: relative; z-index: 2;">
                    <div class="row align-items-center justify-content-center min-vh-50">
                        <div class="col-lg-10 text-center hero-content">
                            <div class="hero-text-box">
                                <h1 class="hero-title">Tissue that lights the room</h1>
                                <p class="hero-subtitle">Featherweight shimmer for evening and glamorous days</p>
                                <p class="hero-description">Experience the luxury of premium clothing that captures every ray of light, creating an ethereal glow that makes you the center of attention. Perfect for special occasions, celebrations, and moments when you want to shine.</p>
                                <div class="text-center mt-4">
                                    <a href="/collections" class="shop-now-btn">SHOP NOW</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Slide 2 -->
        <div class="carousel-item">
            <div class="hero-slide hero-slide-2" style="position: relative; overflow: hidden;">
                <!-- Background Video -->
                <video autoplay muted loop playsinline style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;">
                    <source src="/assets/background.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <!-- Content -->
                <div class="container" style="position: relative; z-index: 2;">
                    <div class="row align-items-center justify-content-center min-vh-50">
                        <div class="col-lg-10 text-center hero-content">
                            <div class="hero-text-box">
                                <h1 class="hero-title">Timeless Elegance</h1>
                                <p class="hero-subtitle">Discover our exquisite collection of traditional and modern clothing</p>
                                <p class="hero-description">From classic designs to contemporary styles, our collection celebrates the rich heritage of fashion. Each piece is carefully curated to bring you the finest quality that blends tradition with modern sophistication.</p>
                                <div class="text-center mt-4">
                                    <a href="/collections" class="shop-now-btn">EXPLORE COLLECTION</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Slide 3 -->
        <div class="carousel-item">
            <div class="hero-slide hero-slide-3" style="position: relative; overflow: hidden;">
                <!-- Background Video -->
                <video autoplay muted loop playsinline style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;">
                    <source src="/assets/background.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <!-- Content -->
                <div class="container" style="position: relative; z-index: 2;">
                    <div class="row align-items-center justify-content-center min-vh-50">
                        <div class="col-lg-10 text-center hero-content">
                            <div class="hero-text-box">
                                <h1 class="hero-title">Festive Collection</h1>
                                <p class="hero-subtitle">Celebrate every occasion with our stunning festive collection</p>
                                <p class="hero-description">Make every celebration memorable with our exclusive festive collection. Featuring vibrant colors, intricate embroideries, and luxurious fabrics, these pieces are designed to make you feel extraordinary on your special days.</p>
                                <div class="text-center mt-4">
                                    <a href="/collections" class="shop-now-btn">SHOP FESTIVE</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
    </button>
</div>

<div class="container my-5">
    <h2 class="section-title">NEW ARRIVALS</h2>
    
    <!-- Category Filter -->
    <div class="text-center mb-5">
        <a href="/collections" class="category-filter-btn <%= selectedCategory === 'all' ? 'active' : '' %>">All</a>
        <% const commonCategories = ['Jeans', 'Shirt', 'Sarees', 'Lehenga', 'Suits']; %>
        <% if (categories && categories.includes('Jeans')) { %>
            <a href="/collections?category=Jeans" class="category-filter-btn <%= selectedCategory === 'Jeans' ? 'active' : '' %>">Jeans</a>
        <% } %>
        <% if (categories && categories.includes('Shirt')) { %>
            <a href="/collections?category=Shirt" class="category-filter-btn <%= selectedCategory === 'Shirt' ? 'active' : '' %>">Shirt</a>
        <% } %>
        <% if (categories && categories.includes('Sarees')) { %>
            <a href="/collections?category=Sarees" class="category-filter-btn <%= selectedCategory === 'Sarees' ? 'active' : '' %>">Sarees</a>
        <% } %>
        <% if (categories && categories.includes('Lehenga')) { %>
            <a href="/collections?category=Lehenga" class="category-filter-btn <%= selectedCategory === 'Lehenga' ? 'active' : '' %>">Lehenga</a>
        <% } %>
        <% if (categories && categories.includes('Suits')) { %>
            <a href="/collections?category=Suits" class="category-filter-btn <%= selectedCategory === 'Suits' ? 'active' : '' %>">Suits</a>
        <% } %>
        <% if (categories && categories.length > 0) { %>
            <% categories.forEach(cat => { %>
                <% if (!commonCategories.includes(cat)) { %>
                    <a href="/collections?category=<%= cat %>" class="category-filter-btn <%= selectedCategory === cat ? 'active' : '' %>">
                        <%= cat %>
                    </a>
                <% } %>
            <% }); %>
        <% } %>
    </div>
    
    <!-- Products Grid -->
    <div class="row g-4">
        <% if (products && products.length > 0) { %>
            <% products.forEach(product => { %>
                <div class="col-md-3 col-sm-6">
                    <div class="card product-card h-100 shadow-sm">
                        <div class="product-image-wrapper" style="position: relative;">
                            <% if (product.discount_percentage && product.discount_percentage > 0) { %>
                                <span class="sale-badge">Sale</span>
                            <% } %>
                            <% if (product.qr_code) { %>
                                <div class="product-qr-code-icon" style="position: absolute; top: 10px; right: 10px; z-index: 10; cursor: pointer; background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" onclick="openQRCodeModal(<%= JSON.stringify(product).replace(/"/g, '&quot;') %>)">
                                    <% if (product.qr_code_image) { %>
                                        <img src="<%= product.qr_code_image %>" alt="QR Code" style="width: 50px; height: 50px; display: block;">
                                    <% } else { %>
                                        <i class="bi bi-qr-code-scan" style="font-size: 2rem; color: var(--veera-accent-dark);"></i>
                                    <% } %>
                                </div>
                            <% } %>
                            <a href="/products/<%= product.id %>">
                                <img src="<%= product.image || '' %>" class="card-img-top" alt="<%= product.title %>" style="height: 380px; object-fit: cover; width: 100%;" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+Tm8gSW1hZ2UgQXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg==';">
                            </a>
                        </div>
                        <div class="card-body d-flex flex-column p-3">
                            <h6 class="card-title mb-2" style="min-height: 45px; font-weight: 600;"><%= product.title %></h6>
                            <!-- Rating Display -->
                            <% if (product.avgRating && product.avgRating > 0) { %>
                                <div class="product-rating mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="star-rating me-2">
                                            <% for (let i = 1; i <= 5; i++) { %>
                                                <i class="bi bi-star<%= i <= Math.round(product.avgRating) ? '-fill' : '' %> text-warning" style="font-size: 0.9rem;"></i>
                                            <% } %>
                                        </div>
                                        <span class="rating-text" style="font-size: 0.85rem; color: #666;">
                                            <strong><%= product.avgRating %></strong> (<%= product.totalRatings || 0 %>)
                                        </span>
                                    </div>
                                </div>
                            <% } else { %>
                                <div class="product-rating mb-2">
                                    <span class="text-muted" style="font-size: 0.85rem;">No ratings yet</span>
                                </div>
                            <% } %>
                            <div class="price-section mb-3">
                                <% if (product.original_price && product.original_price > product.price) { %>
                                    <span class="original-price">Rs. <%= product.original_price.toLocaleString('en-IN', {minimumFractionDigits: 2}) %></span>
                                <% } %>
                                <div class="mt-1">
                                    <span class="current-price">Rs. <%= product.price.toLocaleString('en-IN', {minimumFractionDigits: 2}) %></span>
                                    <% if (product.discount_percentage && product.discount_percentage > 0) { %>
                                        <span class="discount-badge"><%= product.discount_percentage %>% OFF</span>
                                    <% } %>
                                </div>
                            </div>
                            <div class="mt-auto">
                                <% if (product.stock > 0) { %>
                                    <a href="/products/<%= product.id %>" class="btn btn-light-modern w-100 mb-2">
                                        VIEW DETAILS
                                    </a>
                                    <% if (typeof userId !== 'undefined' && userId) { %>
                                        <form action="/cart/add" method="POST" class="d-inline w-100" id="addToCartForm<%= product.id %>">
                                            <%- include('../partials/csrf-token') %>
                                            <input type="hidden" name="productId" value="<%= product.id %>">
                                            <input type="hidden" name="quantity" value="1">
                                            <button type="submit" class="btn btn-gradient-modern w-100">
                                                <i class="bi bi-cart-plus"></i> ADD TO CART
                                            </button>
                                        </form>
                                    <% } %>
                                <% } else { %>
                                    <button class="btn btn-secondary w-100" disabled style="padding: 12px; border-radius: 8px;">Out of Stock</button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="col-12">
                <div class="alert alert-info text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #ddd;"></i>
                    <p class="mt-3">No products found in this category.</p>
                </div>
            </div>
        <% } %>
    </div>
    
    <% if (products && products.length > 0) { %>
        <div class="text-center my-5">
            <a href="/collections" class="btn btn-outline-dark btn-lg" style="padding: 14px 60px; border-radius: 50px; font-weight: 600; letter-spacing: 1px; transition: all 0.3s; border-width: 2px;">
                VIEW ALL COLLECTIONS
            </a>
        </div>
    <% } %>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div class="modal-header" style="border-bottom: 1px solid #e0e0e0; padding: 20px 30px;">
                <h5 class="modal-title" id="qrCodeModalLabel" style="font-weight: 700; color: var(--veera-text);">
                    <i class="bi bi-qr-code-scan"></i> Product QR Code
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div class="row">
                    <div class="col-md-5 text-center mb-4 mb-md-0">
                        <div id="modalQRCodeContainer" style="display: flex; align-items: center; justify-content: center; min-height: 200px;">
                            <canvas id="modalQRCode" style="max-width: 200px; height: auto; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 8px;"></canvas>
                        </div>
                        <div class="mt-3">
                            <code id="modalQRCodeNumber" style="font-size: 0.9rem; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; display: inline-block;"></code>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div id="modalProductImage" class="mb-3" style="text-align: center;">
                            <img id="modalProductImg" src="" alt="Product" style="max-width: 100%; height: 200px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+Tm8gSW1hZ2UgQXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg==';">
                        </div>
                        <h4 id="modalProductTitle" style="font-weight: 700; color: var(--veera-text); margin-bottom: 15px;"></h4>
                        <div class="mb-3">
                            <span id="modalProductCategory" class="badge bg-secondary"></span>
                        </div>
                        <div class="mb-3">
                            <div id="modalProductPrice" style="font-size: 1.5rem; font-weight: 700; color: var(--veera-accent-dark);"></div>
                        </div>
                        <div class="mb-3">
                            <p id="modalProductDescription" class="text-muted" style="line-height: 1.6;"></p>
                        </div>
                        <div class="mb-3">
                            <span id="modalProductStock" class="badge"></span>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <a id="modalViewDetailsLink" href="#" class="btn btn-gradient-modern" style="color: white !important; text-decoration: none;">
                                <i class="bi bi-eye"></i> View Full Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
    function openQRCodeModal(product) {
        // Extract QR code number from full path
        let qrCodeNumber = product.qr_code;
        if (qrCodeNumber && qrCodeNumber.includes('/qrcode/')) {
            qrCodeNumber = qrCodeNumber.split('/qrcode/')[1];
        }
        
        // Set modal content
        document.getElementById('modalProductTitle').textContent = product.title;
        document.getElementById('modalProductCategory').textContent = product.category;
        document.getElementById('modalProductDescription').textContent = product.description;
        const modalImg = document.getElementById('modalProductImg');
        modalImg.src = product.image || '';
        if (!product.image) {
            modalImg.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+Tm8gSW1hZ2UgQXZhaWxhYmxlPC90ZXh0Pjwvc3ZnPg==';
        }
        document.getElementById('modalViewDetailsLink').href = '/products/' + product.id;
        document.getElementById('modalQRCodeNumber').textContent = qrCodeNumber || product.qr_code;
        
        // Set price
        let priceHtml = 'Rs. ' + parseFloat(product.price).toLocaleString('en-IN', {minimumFractionDigits: 2});
        if (product.original_price && parseFloat(product.original_price) > parseFloat(product.price)) {
            priceHtml = '<span class="text-muted text-decoration-line-through me-2">Rs. ' + parseFloat(product.original_price).toLocaleString('en-IN', {minimumFractionDigits: 2}) + '</span>' + priceHtml;
        }
        document.getElementById('modalProductPrice').innerHTML = priceHtml;
        
        // Set stock
        const stockBadge = document.getElementById('modalProductStock');
        if (product.stock > 0) {
            stockBadge.className = 'badge bg-' + (product.stock > 10 ? 'success' : 'warning');
            stockBadge.innerHTML = '<i class="bi bi-check-circle"></i> ' + product.stock + ' in stock';
        } else {
            stockBadge.className = 'badge bg-danger';
            stockBadge.innerHTML = '<i class="bi bi-x-circle"></i> Out of Stock';
        }
        
        // Generate QR code
        const canvas = document.getElementById('modalQRCode');
        const container = document.getElementById('modalQRCodeContainer');
        
        if (product.qr_code_image) {
            // Use QR code image from API
            container.innerHTML = '<img src="' + product.qr_code_image + '" alt="QR Code" style="max-width: 200px; height: auto; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 8px;">';
        } else if (product.qr_code) {
            // Generate QR code
            container.innerHTML = '<canvas id="modalQRCode" style="max-width: 200px; height: auto; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 8px;"></canvas>';
            const newCanvas = document.getElementById('modalQRCode');
            
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(newCanvas, product.qr_code, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) {
                        console.error('QR Code generation error:', error);
                        container.innerHTML = '<div style="padding: 20px; text-align: center; border: 2px dashed #ddd; border-radius: 8px;"><i class="bi bi-qr-code-scan" style="font-size: 3rem; color: #ddd;"></i><p class="mt-2 text-muted">QR Code not available</p></div>';
                    }
                });
            } else {
                // Load QRCode library and retry
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js';
                script.onload = function() {
                    QRCode.toCanvas(newCanvas, product.qr_code, {
                        width: 200,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    });
                };
                document.head.appendChild(script);
            }
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
        modal.show();
    }
    
    // Quantity control functions
</script>

<%- include('../partials/footer') %>
