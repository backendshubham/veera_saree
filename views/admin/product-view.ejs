<%- include('../partials/header') %>

<div class="admin-layout">
    <%- include('../partials/admin-sidebar', { currentPage: 'products' }) %>
    
    <div class="admin-main">
        <%- include('../partials/admin-header', { pageTitle: 'View Product' }) %>
        
        <div class="admin-content">
            <% if (typeof flash !== 'undefined' && flash) { %>
                <div class="alert alert-<%= flash.type === 'error' ? 'danger' : 'success' %> alert-dismissible fade show" role="alert">
                    <%= flash.message %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>
            
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
                <h2 class="mb-0">Product Details</h2>
                <div class="btn-group flex-wrap" role="group">
                    <a href="/admin/products/<%= product.id %>/edit" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Edit Product
                    </a>
                    <a href="/admin/products" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="admin-card mb-4">
                        <h4 class="mb-4"><%= product.title %></h4>
                        
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">Product ID</label>
                                <div><strong>#<%= product.id %></strong></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">Category</label>
                                <div>
                                    <span class="badge bg-secondary"><%= product.category %></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label text-muted">Description</label>
                            <div style="line-height: 1.8; color: var(--veera-text);">
                                <%= product.description %>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <label class="form-label text-muted">Original Price</label>
                                <div>
                                    <% if (product.original_price && product.original_price > product.price) { %>
                                        <strong style="text-decoration: line-through; color: #999;">
                                            ₹<%= product.original_price.toLocaleString('en-IN', {minimumFractionDigits: 2}) %>
                                        </strong>
                                    <% } else { %>
                                        <span class="text-muted">Not set</span>
                                    <% } %>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label text-muted">Selling Price</label>
                                <div>
                                    <strong style="font-size: 1.3rem; color: var(--veera-accent-dark);">
                                        ₹<%= product.price.toLocaleString('en-IN', {minimumFractionDigits: 2}) %>
                                    </strong>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label text-muted">Discount</label>
                                <div>
                                    <% if (product.discount_percentage && product.discount_percentage > 0) { %>
                                        <span class="badge bg-success">
                                            <%= product.discount_percentage %>% OFF
                                        </span>
                                    <% } else { %>
                                        <span class="text-muted">No discount</span>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">Stock Quantity</label>
                                <div>
                                    <span class="badge bg-<%= product.stock > 10 ? 'success' : product.stock > 0 ? 'warning' : 'danger' %>" style="font-size: 1rem; padding: 8px 16px;">
                                        <%= product.stock %> units
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">Status</label>
                                <div>
                                    <span class="badge bg-<%= product.stock > 0 ? 'success' : 'danger' %>" style="font-size: 1rem; padding: 8px 16px;">
                                        <%= product.stock > 0 ? 'In Stock' : 'Out of Stock' %>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <% if (product.avgRating && product.avgRating > 0) { %>
                            <div class="mb-4">
                                <label class="form-label text-muted">Customer Rating</label>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="star-rating">
                                        <% for (let i = 1; i <= 5; i++) { %>
                                            <i class="bi bi-star<%= i <= Math.round(product.avgRating) ? '-fill' : '' %> text-warning" style="font-size: 1.2rem;"></i>
                                        <% } %>
                                    </div>
                                    <span style="font-size: 1.1rem; font-weight: 600;">
                                        <%= product.avgRating %> (<%= product.totalRatings %> <%= product.totalRatings === 1 ? 'review' : 'reviews' %>)
                                    </span>
                                </div>
                            </div>
                        <% } %>
                        
                        <div class="mb-3">
                            <label class="form-label text-muted">Created At</label>
                            <div>
                                <%= new Date(product.created_at).toLocaleString('en-IN', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) %>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="admin-card mb-4">
                        <h6 class="mb-3">Product Image</h6>
                        <div style="width: 100%; height: 400px; background: #f5f5f5; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 1rem;">
                            <img src="<%= product.image %>" alt="<%= product.title %>" 
                                 style="max-width: 100%; max-height: 100%; object-fit: cover;">
                        </div>
                    </div>
                    
                    <% if (product.qr_code) { %>
                        <div class="admin-card">
                            <h6 class="mb-3"><i class="bi bi-qr-code-scan"></i> Product QR Code</h6>
                            <div class="mb-3 p-3" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div class="text-center mb-3">
                                    <% if (product.qr_code_image) { %>
                                        <img src="<%= product.qr_code_image %>" alt="QR Code" style="max-width: 200px; height: auto; display: block; margin: 0 auto; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 8px;">
                                    <% } else { %>
                                        <div id="qrCodeContainer" style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                            <canvas id="qrCodeDisplay" style="max-width: 200px; height: auto; display: block; margin: 0 auto; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 8px;"></canvas>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="text-center">
                                    <code style="font-size: 0.9rem; padding: 8px 12px; background: white; border-radius: 6px; display: inline-block;">
                                        <%= product.qrCodeNumber || product.qr_code %>
                                    </code>
                                </div>
                                <div class="d-grid gap-2 mt-3">
                                    <button type="button" class="btn btn-primary" onclick="printQRCode('<%= product.qr_code %>', '<%= product.title %>', '<%= product.category %>', '<%= product.price %>', '<%= product.id %>', '<%= product.image || "" %>')">
                                        <i class="bi bi-printer"></i> Print QR Code Sticker
                                    </button>
                                    <% if (product.qrCodeNumber) { %>
                                        <a href="/products/qrcode/<%= product.qrCodeNumber %>" target="_blank" class="btn btn-outline-info">
                                            <i class="bi bi-qr-code"></i> View via QR Scanner
                                        </a>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% } else { %>
                        <div class="admin-card">
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-info-circle"></i> QR Code not generated yet. Edit the product to generate one.
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.js"></script>
<script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
    <% if (product.qr_code) { %>
        // Display QR code - using multiple fallback methods
        (function() {
            let retryCount = 0;
            const maxRetries = 20;
            
            function generateQRCode() {
                const canvas = document.getElementById('qrCodeDisplay');
                if (!canvas) {
                    console.error('Canvas element not found');
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(generateQRCode, 200);
                    }
                    return;
                }
                
                // Try QRCode library
                if (typeof QRCode !== 'undefined') {
                    try {
                        console.log('Generating QR code for:', '<%= product.qr_code %>');
                        QRCode.toCanvas(canvas, '<%= product.qr_code %>', {
                            width: 200,
                            margin: 2,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            },
                            errorCorrectionLevel: 'M'
                        }, function (error) {
                            if (error) {
                                console.error('QR Code generation error:', error);
                                // Fallback: show barcode number with link
                                const container = document.getElementById('qrCodeContainer');
                                if (container) {
                                    container.innerHTML = '<div style="padding: 20px; text-align: center; border: 2px dashed #ddd; border-radius: 8px;"><strong>QR Code:</strong><br><code style="font-size: 14px; padding: 10px; background: #f0f0f0; border-radius: 4px; display: inline-block; margin-top: 10px;"><%= product.qr_code %></code><br><small style="color: #666; margin-top: 10px; display: block;">Scan this code to view product</small></div>';
                                }
                            } else {
                                console.log('QR Code generated successfully');
                                canvas.style.border = 'none';
                            }
                        });
                    } catch (e) {
                        console.error('QR Code generation exception:', e);
                    }
                } else {
                    // Library not loaded, retry
                    if (retryCount < maxRetries) {
                        retryCount++;
                        console.log('QRCode library not loaded, retrying...', retryCount);
                        setTimeout(generateQRCode, 300);
                    } else {
                        console.error('QRCode library failed to load after', maxRetries, 'retries');
                        const container = document.getElementById('qrCodeContainer');
                        if (container) {
                            container.innerHTML = '<div style="padding: 20px; text-align: center; border: 2px dashed #ddd; border-radius: 8px;"><strong>QR Code:</strong><br><code style="font-size: 14px; padding: 10px; background: #f0f0f0; border-radius: 4px; display: inline-block; margin-top: 10px;"><%= product.barcode %></code><br><small style="color: #666; margin-top: 10px; display: block;">Library loading issue. Please refresh the page.</small></div>';
                        }
                    }
                }
            }
            
            // Wait for everything to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(generateQRCode, 300);
                });
            } else {
                setTimeout(generateQRCode, 300);
            }
        })();
        
        // Print QR Code Sticker Function
        window.printQRCode = function(qrCode, title, category, price, productId, image) {
            const shopName = 'VEERA SAREE CENTER';
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code Sticker - ${title}</title>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"><\/script>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body {
                            font-family: 'Arial', 'Helvetica', sans-serif;
                            padding: 10px;
                            background: #f5f5f5;
                        }
                        .sticker-container {
                            width: 3.5in;
                            height: 2.5in;
                            border: 2px solid #000;
                            padding: 12px;
                            margin: 5px;
                            display: inline-block;
                            vertical-align: top;
                            page-break-inside: avoid;
                            background: white;
                        }
                        .shop-name {
                            text-align: center;
                            font-size: 16px;
                            font-weight: bold;
                            margin-bottom: 10px;
                            border-bottom: 2px solid #000;
                            padding-bottom: 6px;
                            letter-spacing: 0.5px;
                        }
                        .product-details {
                            display: flex;
                            gap: 12px;
                            align-items: flex-start;
                        }
                        .product-image-section {
                            flex-shrink: 0;
                            width: 80px;
                            height: 80px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            overflow: hidden;
                            background: #f5f5f5;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .product-image-section img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }
                        .product-info {
                            flex: 1;
                            font-size: 11px;
                            line-height: 1.4;
                        }
                        .product-info .product-title {
                            font-weight: bold;
                            margin-bottom: 6px;
                            font-size: 13px;
                            color: #000;
                            word-wrap: break-word;
                        }
                        .product-info .product-category {
                            color: #333;
                            margin-bottom: 4px;
                            font-size: 11px;
                        }
                        .product-info .product-price {
                            font-weight: bold;
                            color: #d32f2f;
                            font-size: 14px;
                            margin: 6px 0;
                        }
                        .product-info .product-id {
                            font-size: 10px;
                            color: #666;
                            margin-top: 4px;
                        }
                        .qr-code-section {
                            text-align: center;
                            flex-shrink: 0;
                        }
                        .qr-code-section canvas {
                            width: 100px !important;
                            height: 100px !important;
                            display: block;
                            margin: 0 auto;
                            border: 1px solid #ddd;
                            padding: 4px;
                            background: white;
                        }
                        .loading-text {
                            text-align: center;
                            color: #666;
                            font-size: 10px;
                            padding: 20px;
                        }
                        @media print {
                            body { 
                                margin: 0; 
                                padding: 0;
                                background: white;
                            }
                            .sticker-container { 
                                page-break-inside: avoid;
                                margin: 0;
                                border: 2px solid #000;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="sticker-container">
                        <div class="shop-name">${shopName}</div>
                        <div class="product-details">
                            <div id="productImageContainer" class="product-image-section" style="display: none;">
                                <img id="productImage" src="" alt="${title}" onerror="document.getElementById('productImageContainer').style.display='none';">
                            </div>
                            <div class="product-info">
                                <div class="product-title">${title}</div>
                                <div class="product-category"><strong>Category:</strong> ${category}</div>
                                <div class="product-price">₹${parseFloat(price).toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>
                                <div class="product-id"><strong>ID:</strong> #${productId}</div>
                            </div>
                            <div class="qr-code-section">
                                <div id="loadingText" class="loading-text">Generating QR Code...</div>
                                <canvas id="qrcode" style="display: none;"></canvas>
                            </div>
                        </div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"><\/script>
                    <script>
                        // Set product image if provided
                        const productImage = '${image || ""}';
                        if (productImage && productImage.trim() !== '') {
                            const imgContainer = document.getElementById('productImageContainer');
                            const img = document.getElementById('productImage');
                            if (imgContainer && img) {
                                let imageUrl = productImage;
                                // If it's a local path, construct full URL
                                if (imageUrl.startsWith('/')) {
                                    imageUrl = window.location.origin + imageUrl;
                                }
                                img.src = imageUrl;
                                imgContainer.style.display = 'flex';
                            }
                        }
                        
                        function generatePrintQRCode() {
                            const canvas = document.getElementById('qrcode');
                            const loadingText = document.getElementById('loadingText');
                            
                            if (!canvas) {
                                if (loadingText) loadingText.textContent = 'Canvas not found';
                                return;
                            }
                            
                            const qrCodeValue = '${qrCode}';
                            if (!qrCodeValue || qrCodeValue.trim() === '') {
                                if (loadingText) loadingText.textContent = 'Invalid QR Code';
                                return;
                            }
                            
                            if (typeof QRCode === 'undefined') {
                                if (loadingText) loadingText.textContent = 'Loading QR Code library...';
                                setTimeout(generatePrintQRCode, 200);
                                return;
                            }
                            
                            try {
                                QRCode.toCanvas(canvas, qrCodeValue, {
                                    width: 200,
                                    margin: 2,
                                    color: {
                                        dark: '#000000',
                                        light: '#FFFFFF'
                                    },
                                    errorCorrectionLevel: 'M'
                                }, function (error) {
                                    if (error) {
                                        console.error('QR Code generation error:', error);
                                        if (loadingText) loadingText.textContent = 'Error: ' + error.message;
                                    } else {
                                        canvas.style.display = 'block';
                                        if (loadingText) loadingText.style.display = 'none';
                                        
                                        // Wait a bit more to ensure canvas is rendered
                                        setTimeout(function() {
                                            window.print();
                                        }, 500);
                                    }
                                });
                            } catch (e) {
                                console.error('QR Code generation exception:', e);
                                if (loadingText) loadingText.textContent = 'Error: ' + e.message;
                            }
                        }
                        
                        // Wait for page and script to load
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', function() {
                                setTimeout(generatePrintQRCode, 500);
                            });
                        } else {
                            setTimeout(generatePrintQRCode, 500);
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        };
    <% } %>
    
    // Sidebar toggle
    document.getElementById('mobileSidebarToggle')?.addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebarOverlay').classList.toggle('active');
    });
    
    document.getElementById('sidebarToggle')?.addEventListener('click', function() {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
    });
    
    document.getElementById('sidebarOverlay')?.addEventListener('click', function() {
        document.getElementById('sidebar').classList.remove('active');
        this.classList.remove('active');
    });
</script>
</body>
</html>

